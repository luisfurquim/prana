var sep,prana;const txt=0,ref=1,str=2,dot=3,open=4,close=5,num=6,ident=7,wsep=8,expr=9,attr=10,needle=["{","}"];sep='.';function textParse(b){for(var a=0,c=0,d=[],e=txt;a<b.length;)b[a]==needle[e]&&a+1<b.length&&b[a+1]==needle[e]&&(e==txt?a>c&&d.push({type:txt,val:b.substring(c,a)}):d.push({type:ref,val:b.substring(c,a)}),a++,c=a+1,e^=1),a++;return c<b.length&&d.push({type:txt,val:b.substring(c,a)}),d}function tokenize(g){var f=[],e=parseString(g),d,a,b,c;for(d=0;d<e.length;d++){if(e[d].type==str){f.push(e[d]);continue}b=e[d].val.split(/([.\[\]])|([+-]?(?:[0-9]+(?:[.][0-9]*)?|[.][0-9]+))|([a-zA-Z_\$][0-9a-zA-Z_\$]*)/g);for(a=0;a<b.length;a++)if(b[a]){if(b[a]==".")c=dot;else if(b[a]=="[")c=open;else if(b[a]=="]")c=close;else if(b[a][0].match(/^[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)$/))c=num,b[a]=parseInt(b[a]);else if(b[a][0].match(/[a-zA-Z_\$][0-9a-zA-Z_\$]*/))c=ident;else continue;f.push({type:c,val:b[a]})}}return f}function parseString(b){var e=txt,d=[],a,f,c;for(a=0,c=0;a<b.length;a++)e==txt?(b[a]=="'"||b[a]=='"')&&(e=str,f=b[a],a>c&&d.push({type:txt,val:b.substring(c,a)}),c=a+1):b[a]==f&&(e=txt,d.push({type:str,val:b.substring(c,a)}),c=a+1);return c<b.length&&d.push({type:txt,val:b.substring(c,a)}),d}function parseReference(a){var c=[],d=wsep,b;if(a.length==0)throw"empty reference";if(b=a.splice(0,1)[0],b.type==num||b.type==str)if(a.length==0||a[0].type==close)return a.splice(0,1),[b];if(b.type!=ident)throw"syntax error";for(c.push(b);a.length>0&&a[0].type!=close;)if(b=a.splice(0,1)[0],d==wsep){if(b.type==open){c.push({typ:expr,val:parseReference(a)});continue}if(b.type!=dot)throw"syntax error";d=ref}else{if(b.type==ident||b.type==str){c.push(b),d=wsep;continue}throw"syntax error"}return a.length>0&&a[0].type==close&&a.splice(0,1),c}function solve(b,d){var c=d,a,e;for(a=0;a<b.length;a++)b[a].type==str||b[a].type==num||b[a].type==txt?c=b[a].val:b[a].type==ident?c=c[b[a].val]:c=c[solve(b[a].val,d)];return c}function isPureReference(b){var a;for(a=0;a<b.length;a++)if(b[a].type==str||b[a].type==num||b[a].type==txt)return!1;return!0}function refOf(g,c){var e=c,b,d,f,a;for(d=0;d<g.length;d++)if(a!==void 0&&(e=e[a]),g[d].type==ident)a=g[d].val;else{b=-1;do b++,[f,a]=refOf(g[d],[c[b]]),f!==void 0&&(f=f[0]);while(b<c.length&&(a===void 0||f[a]===void 0))if(b>=c.length||c[b][a]===void 0)return[void 0,void 0];e=c[b]}return[e,a]}function getReferences(a){var c={},o=[],f=!1,h,d,g,b,m,i,j,l,e,n,k;if(a.nodeName=="#text"){d=textParse(a.data),c.type=txt,c.ref=[];for(b=0;b<d.length;b++)d[b].type==ref?(f=!0,c.ref.push(parseReference(tokenize(d[b].val)))):c.ref.push([d[b]]);return f?c:void 0}if(a.nodeType!=1)return void 0;c.type=attr,c.refs={},c.children={};for(b=0;b<a.attributes.length;b++){if(a.attributes[b].name.substr(0,1)=="*"){i=a.attributes[b].name.substr(1),f=!0;continue}if(a.attributes[b].name.substr(0,1)=="?"){j=a.attributes[b].name.substr(1),f=!0;continue}d=textParse(a.attributes[b].value),g=[],m=!1;for(h=0;h<d.length;h++)d[h].type==ref?(f=!0,m=!0,g.push(parseReference(tokenize(d[h].val)))):g.push([d[h]]);m&&(c.refs[a.attributes[b].name]=g,isPureReference(g)&&(a.attributes[b].pranaRef=g,a.attributes[b].name=="value"&&(k=a.tagName.toLowerCase(),(k=="input"||k=="select"||k=="textarea")&&(a.attributes[b].pranaTrackValue=function(a){return function(b){var c,d,e,f,g;for(c=0;c<b.target.attributes.length;c++)if(b.target.attributes[c].name=="value"){d=b.target.attributes[c],d.pranaRef!==void 0&&d.pranaCtx!==void 0&&([e,f]=refOf(d.pranaRef,d.pranaCtx),e!==void 0&&f!==void 0&&e[f]!=b.target.value&&(g=!0,e[f]=b.target.value));break}typeof a=="function"&&a(b)}}(a.onchange),a.onchange=a.pranaTrackValue))))}j!==void 0&&(c.cond=j,a.removeAttribute("?"+j),a.tree=parseReference(tokenize(j))),i!==void 0&&(c.arrayVar=i,a.removeAttribute("*"+i),e=document.createElement("SPAN"),e.setAttribute("style","margin: 0px; padding: 0px;"),e.model=a,[e.aCtrl,e.aIndex]=i.split(":"),e.tree=parseReference(tokenize(e.aCtrl)),n=a.parentNode,n.replaceChild(e,a));for(b=0;b<a.childNodes.length;b++)l=getReferences(a.childNodes[b]),l!==void 0&&(f=!0,c.children[b]=l);return f?c:void 0}function solveAll(e,f){var a,b,d,c;d="";for(a=0;a<e.length;a++){b=0;do c=solve(e[a],f[b]),b++;while(c===void 0&&b<f.length)c!==void 0&&(d+=c)}return d}function syncElement(b,d,f,h){var a,g,c,e;for(a in d.refs)d.refs.hasOwnProperty(a)&&(g=solveAll(d.refs[a],f),b.setAttribute(a,g),c=b.getAttributeNode(a),c.name=="value"&&(e=b.tagName.toLowerCase(),(e=="input"||e=="select"||e=="textarea")&&(b.value=g)),c.pranaRef!==void 0&&(c.pranaTrackValue!==void 0&&(b.onchange=function(d){for(var a=b;a!==null&&a.prana===void 0;)a=a.parentNode;c.pranaTrackValue(d),a!==null&&a.prana!==void 0&&a.prana.sync()}),c.pranaCtx=f));for(a in d.children)sync(b.childNodes[a],d.children[a],f,h)}function stack(e,c,d){var b=[e],a;for(a=0;a<c.length;a++)b.push(c[a]);for(a=0;a<d.length;a++)b.push(d[a]);return b}function cloneRefs(b,c){var a;for(a=0;a<b.attributes.length;a++)b.attributes[a].pranaRef!==void 0&&(c.attributes[a].pranaRef=b.attributes[a].pranaRef,b.attributes[a].pranaTrackValue!==void 0&&(c.attributes[a].pranaTrackValue=b.attributes[a].pranaTrackValue,c.onchange=c.pranaTrackValue));for(a=0;a<b.childNodes.length;a++)cloneRefs(b.childNodes[a],c.childNodes[a])}function cloneNode(b){var a;return a=b.cloneNode(!0),cloneRefs(b,a),a}function condSync(a,i,e,j,h){var c,b,d,f,g;a.nodeType==Node.COMMENT_NODE?f=a.model.tree:f=a.tree,c=0;do b=solve(f,e[c]),c++;while(b===void 0&&c<e.length)typeof b=="function"&&(b=b(j)),b?(a.nodeType==Node.COMMENT_NODE&&(g=a.model,a.parentNode.replaceChild(a.model,a),a=g),syncElement(a,i,e,h)):a.nodeType==Node.ELEMENT_NODE&&(d=document.createComment("if false"),d.model=a,a.parentNode.replaceChild(d,a))}function sync(b,c,d,g){var a,e,h,f,i;if(c.type==txt)b.parentNode!==null&&b.parentNode!==void 0&&b.parentNode.tagName.toLowerCase()=="textarea"?b.parentNode.value=solveAll(c.ref,d):b.data=solveAll(c.ref,d);else if(c.arrayVar){a=0;do e=solve(b.tree,d[a]),a++;while(e===void 0&&a<d.length)if(e===void 0)throw"Unresolved symbol "+b.aCtrl+" during array syncing";for(a=0;a<e.length&&a<b.childNodes.length;a++)f={},f[b.aIndex]=a,c.cond?condSync(b.childNodes[a],c,stack(f,[e[a]],d),a,g):syncElement(b.childNodes[a],c,stack(f,[e[a]],d),g);for(;a<e.length;a++)f={},f[b.aIndex]=a,b.appendChild(cloneNode(b.model)),c.cond?(b.childNodes[a].tree=b.model.tree,condSync(b.childNodes[a],c,stack(f,[e[a]],d),a,g)):syncElement(b.childNodes[a],c,stack(f,[e[a]],d),g);while(a<b.childNodes.length)b.removeChild(b.childNodes[a])}else c.cond?condSync(b,c,d,void 0,g):syncElement(b,c,d,g)}function bind(c,a,e){var b=a.parentNode.host,d;if(c.__isProxy)return c;do b=b.parentNode;while(b!==void 0&&b!==null&&b!==document&&b.prana===void 0)a.prana={this:c,refs:getReferences(e),syncLocal:function(b){sync(e,a.prana.refs,[a.prana.this],b)},syncUp:function(g){var b,d,e,f=!1,c=a.parentNode.host;for(b=0;b<c.attributes.length;b++)a.prana.this.hasOwnProperty(c.attributes[b].name)&&c.attributes[b].pranaRef!==void 0&&c.attributes[b].pranaCtx!==void 0&&([d,e]=refOf(c.attributes[b].pranaRef,c.attributes[b].pranaCtx),d!==void 0&&e!==void 0&&d[e]!=a.prana.this[c.attributes[b].name]&&(f=!0,d[e]=a.prana.this[c.attributes[b].name]));f&&a.prana.parent!==void 0&&(a.prana.parent.prana.syncLocal(g),a.prana.parent.prana.syncUp(a))},sync:function(){a.prana.syncLocal(!0),a.prana.syncUp(a)}},b!==void 0&&b!==null&&b!==document&&b.prana!==void 0&&(a.prana.parent=b.parentNode.host.root);try{a.prana.sync()}catch(a){}return a.appendChild(e),setTimeout(function(){var b,c,d,e=!1;for(b=0;b<a.parentNode.host.attributes.length;b++)a.prana.this[a.parentNode.host.attributes[b].name]=a.parentNode.host.attributes[b].value;a.prana.syncLocal(!0)},10),d={apply:function(a,b,c){return console.log("apply",a,b,c,this),b[a].apply(this,argumentList)},get:(b,a)=>a==="__isProxy"||(b.hasOwnProperty(a)&&typeof b[a]=="object"&&b[a]!==null?new Proxy(b[a],d):b[a]),deleteProperty:function(a,b){return console.log("del",a,b),console.log("prx",d),console.log("data",c),!0},set:function(b,c,d,e){return b[c]=d,a.prana.sync(),!0}},new Proxy(c,d)}prana={propagate:{},def:function(c){var a,e,b,d;b=Object.keys(c.modules),a=new Array(b.length);for(let f=0;f<b.length;f++){if(e=[],typeof b[f]!="string"||typeof c.modules[b[f]]!="string")throw"Needs tag and js definitions";a[f]={},d=c.modules[b[f]].split("/"),d=d[d.length-1],e.push(import(c.dir+c.modules[b[f]]+"/"+d+".js").then(function(b){return new Promise(function(c,d){a[f].js=b.default,a[f].attr=b.attr,c()})})),e.push(fetch(new Request(c.dir+c.modules[b[f]]+"/"+d+".html")).then(function(b){return new Promise(function(c,d){b.ok?b.text().then(function(b){a[f].html=document.createElement('template'),a[f].html.innerHTML=b,c()}):d()})})),e.push(fetch(new Request(c.dir+c.modules[b[f]]+"/"+d+".css")).then(function(b){return new Promise(function(c,d){b.ok?b.text().then(function(b){var d;a[f].css=document.createElement('style'),a[f].css.innerText=b,c()}):d()})})),Promise.all(e).then(function(){customElements.define(b[f],class extends HTMLElement{static get observedAttributes(){return a[f].attr!==void 0?a[f].attr:[]}constructor(){var b,c;super(),b=this,this.root={},c=function(c){return function(){var h=a[f].html.content.cloneNode(!0).children[0],d,g,e,i,j,k;a[f].css!==void 0&&(i=a[f].css.cloneNode(!0));for(d=0;d<b.attributes.length;d++)g=b.attributes[d],c[g.name]=g.value;let l=b.attachShadow({mode:"open"});i!==void 0&&l.appendChild(i),b.root=document.createElement("SPAN"),l.appendChild(b.root),b.root.appendChild(h),j=function(a,c){e!==void 0?setTimeout(function(){a({this:e,dom:b.root})},500):setTimeout(function(){j(a,c)},10)},k=new Promise(j),c=a[f].js.call(c,k),e=bind(c,b.root,h)}}({}),c()}attributeChangedCallback(b,c,a){this.root.prana.this[b]=a,c!=a&&this.root.prana.sync()}})})}}};export default prana
